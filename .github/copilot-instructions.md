# GitHub Copilot 全体の指示書

- このファイルは、このリポジトリで GitHub Copilot を効果的に使用するためのガイドラインと手順を提供します。
- このリポジトリではTypeScriptのNestJSによるWebアプリケーションの開発を行います。
- このリポジトリではDDD的手法を取り入れ、NestJSとビジネスロジックが疎結合であることを維持します。
- このリポジトリではTDDで開発を進めます。まず必要なテストケースを実装し、それから機能を実装します。
- このリポジトリではチケットドリブンで開発を進めます。githubのイシューをチケットとして扱い、チケットが作られるまで実装を始めません。
- 開発メンバーは日本人なのでコメントやコミットメッセージ、イシュー、プルリク、レビューなどは日本語で記述します。

## 振る舞い
 
 - TypeScript、Node.js、NestJS、Effect-TS、Prisma、GraphQL、SqLite、MySql、Vitest、Tailwind CSS、gitのエキスパートとして振る舞います。
 - AIエージェントはMCPサーバを利用してローカルのgitリポジトリおよびgithubのリモートリポジトリを操作します。

## 使用技術スタック
 
 ### 基本事項
 
 - 言語: TypeScript、Node.js
 - フレームワーク: NestJS
 - UIライブラリ: Tailwind CSS
 - DBライブラリ: Prisma
 - テストフレームワーク: Vitest

## 開発環境

- 開発コンテナには、Docker CLI（`docker`）が事前にインストールされており、`PATH` に設定されています。
- ホストマシンで Docker デーモンが実行されていることを確認してください。

## チケットドリブンによる開発の手順

1. 開発メンバーはAIエージェントと会話を行い、開発に必要な要件を洗い出します。
2. AIエージェントは要件を解釈し、タスクとして切り出し提示します。
3. 開発メンバーはAIエージェントと会話を行い、提示されたタスクの範囲と内容が適切か確認します。
4. 問題なければAIエージェントはgithubのmcpサーバを利用してタスクをイシューとして登録します。
5. 開発メンバーはgithubで登録されたイシューの内容を確認し、もし必要ならコメントを追加します。
6. AIエージェントはイシュー番号を受け取ったら、そのイシューと付けられたコメントを確認します。
7. AIエージェントは確認した内容に沿って作業を行うブランチに切り替えます。ブランチ名は「feature/（イシュー番号）」です。
8. AIエージェントはTDDで開発を進めるのでまずテストケースを作成します。
9. AIエージェントはテストが通るように機能実装を行います。
10. AIエージェントは実装完了したならコミットし、githubのリモートリポジトリにプッシュしてプルリクを出します。
11. 開発メンバーはプルリクの内容を確認し、動作確認し、問題があればプルリクにコメントを追加します。
12. AIエージェントは追加したコメントを確認し、問題が解決されるまで開発の手順の8、9、10、11、12を繰り返します。
13. 開発メンバーは問題がなくなったことを確認できればメインブランチにマージし、イシューを閉じます。

## DDD的手法の実践

### 1. ディレクトリ構成例

```
/
├── src/                     # アプリケーションコード（TypeScript）
│   ├── domain/              # ドメイン層（エンティティ、値オブジェクト、サービス、リポジトリIF）
│   |   └── user/            # ユーザードメイン
│   │       ├── entity/      # エンティティ
│   │       ├── repository/  # リポジトリインターフェース
│   │       └── service/     # ドメインサービス
│   ├── usecase/             # ユースケース層（ドメインサービス呼び出し、Effect.genを使用）
│   ├── infrastructure/      # インフラ層（Prismaなど実装依存の具体クラス）
│   │   ├── prisma/          # Prismaの実装
│   │   └── repository/      # リポジトリの実装
│   ├── interfaces/          # プレゼンテーション層（Controller, View, Pipe, Guardなど）
│   │   ├── controller/      # コントローラ層
│   │   ├── pipes/
│   │   ├── guards/
│   │   └── views/           # View関連の共通ヘルパーなどを置くならここ
│   ├── shared/              # 共通モジュールやユーティリティ
│   │   └── dto/             # データ転送オブジェクト（DTO）
│   └── main.ts              # NestJS アプリのエントリポイント
├── views/                   # テンプレートファイル（ejs）
├── public/                  # 静的ファイル（CSS, JS, 画像など）
├── dist/                    # ビルド成果物（tscによる出力先）
├── tests/                   # 単体・統合テストコード
├── package.json
├── tsconfig.json
└── README.md
```

### 2. NestJSフレームワークとビジネスロジックの疎結合の維持戦略

1. ドメイン層にはリポジトリインターフェース（IUserRepositoryなど）を定義し、インフラ層ではその実装（Prismaなど）を提供し、NestJSのDI機能で依存性注入します。
2. ユースケース層はドメイン層のリポジトリインターフェースからデータ操作を行い、ドメインサービスについてもDIで受け取り、それらを用いてビジネスロジック処理を行います。
3. コントローラ層はユースケース層を呼び出し、ドメイン層のビジネスロジックを分離するために、リポジトリやドメインサービスに依存しません。
4. コントローラ層はリクエストを受け取り、ユースケース層に処理を委譲します。これにより、コントローラはアプリケーションフローの調整のみを担当し、ビジネスロジックとは分離されます。
5. 以上の方針を守ることで、NestJSフレームワークの依存をユースケース層までに留め、ビジネスロジックとの疎結合を維持しながらプロジェクトを進めることができます。

### 3. 頑強で一貫性のあるビジネスロジック

1. ドメイン層はEffect-TSで管理し、各クラスのすべてのメソッドはEffect型を返します。Effectで返す型は成功時の型とエラー型に限定します。
2. 返り値の型にR型（環境依存）は指定しません。すべて `Effect<never, A>` または `Effect<E, A>` です。これはレビュー時の負担軽減のためです。
3. ドメイン層のビジネスロジックの各Effectを実行するのはユースケース層です。`Effect.gen`で逐次的に記述していきます。これもレビュー時の負担軽減のためです。
4. ドメイン層とユースケース層以外ではEffect-TSを利用しません。NestJSの処理は汎用的なものばかりで厳格さは求めていません。

## ビューに関する指示

 - レスポンスで返すHTMLはEJSを利用します。
 - EJSのテンプレートファイルは/viewsにコントローラとの対応関係が明確になるように配置してください。

## DBに関する指示

 - DBのテーブル定義はPrismaの流儀に従ってスキーマファイルに定義してください。
 - テーブルの追加、定義変更はスキーマファイルを用いてprismaのコマンドでマイグレーションしてください。

## テストに関する指示

 - vitest を使用したユニットテストの記述をしてください。
 - テストはdescribeでグループ化し、itでテストケースを記述してください。
 - テストケースは日本語で記述してください。

## 使用ガイドライン

1. **コード提案**: GitHub Copilot を使用してコードスニペット、ボイラープレート、テンプレートを生成します。
2. **生成コードの確認**: 生成されたコードを必ず確認し、プロジェクト要件を満たしていることを確認してください。
3. **標準の遵守**: このリポジトリで定義されたコーディング標準とベストプラクティスに従ってください。

## 注意事項

- Copilot の提案がシステムメッセージやリポジトリのガイドラインと矛盾する場合は、後者を優先してください。
- 詳細については、[GitHub Copilot ドキュメント](https://docs.github.com/copilot) を参照してください。
